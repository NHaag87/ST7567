import RPi.GPIO as GPIO
from time import sleep
import spidev
import numpy as np

ST7567_DISPLAY_ON =                 0b10101111 # AF
ST7567_DISPLAY_OFF =                0b10101110 # AE
ST7567_SET_START_LINE =             0b01000000 # 40
ST7567_SET_PAGE_ADDRESS =           0b10110000 # B0
ST7567_SET_COLUMN_ADDRESS_MSB =     0b00010000 # 10
ST7567_SET_COLUMN_ADDRESS_LSB =     0b00001111 # 0F
ST7567_SEG_DIRECTION_NORMAL =       0b10100000 # A0
ST7567_SEG_DIRECTION_REVERSE =      0b10100001 # A1
ST7567_INVERSE_DISPLAY_ON =         0b10100111 # A7
ST7567_INVERSE_DISPLAY_OFF =        0b10100110 # A6
ST7567_ALL_PIXEL_ON =               0b10100101 # A5
ST7567_ALL_PIXEL_OFF =              0b10100100 # A4
ST7567_BIAS_SELECT_1OVER9 =         0b10100010 # A3
ST7567_BIAS_SELECT_1OVER7 =         0b10100011 # A2
ST7567_RESET =                      0b11100010 # E2
ST7567_COM_DIRECTION_REVERSE =      0b11001000 # C8
ST7567_COM_DIRECTION_NORMAL =       0b11000000 # C0
ST7567_POWER_CONTROL =              0b00101000 # 29
ST7567_REGULATION_RATIO =           0b00100000 # 20
ST7567_SET_CONTRAST =               0b10000001 # 81
ST7567_SET_BOOSTER =                0b11111000 # F8

test_image = [0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x1F,0x5F,0x5F,0x9F,0x9F,0xDF,0x1F,
                  0x1F,0xDF,0x9F,0xFF,0xCF,0xCF,0x6F,0x0F,0x8F,0xFF,0x0F,0x0F,0xAF,0x2F,0x6F,0xFF,0x1F,0x0F,0x6F,0x4F,0xDF,0xFF,0xCF,0xCF,0x6F,0x0F,0x8F,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF9,0xFB,0xFA,0xF8,0xFC,0xFF,0xFB,0xF8,0xF8,0xFB,0xFF,0xFF,0xFF,0xF9,0xF8,
                  0xFE,0xFF,0xFF,0xF9,0xFB,0xFB,0xF8,0xFC,0xFF,0xFC,0xF8,0xFB,0xF8,0xFC,0xFF,0xFF,0xF9,0xF8,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xCF,0xEF,0x0F,0x0F,0xEF,
                  0xCF,0xFF,0x3F,0x1F,0x5F,0x1F,0x3F,0xFF,0xBF,0x1F,0x1F,0x5F,0x5F,0xFF,0xDF,0x07,0x07,0xDF,0xDF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xEF,
                  0x0F,0x0F,0xEF,0xFF,0xDF,0x1F,0x9F,0x1F,0x9F,0x3F,0xFF,0xBF,0x1F,0x5F,0x1F,0x3F,0xFF,0x3F,0x1F,0xDF,0x3F,0x1F,0xDF,0x3F,0x1F,0x5F,0x1F,
                  0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFD,0xFC,0xFC,0xFD,0xFF,0xFF,0xFE,0xFC,0xFD,0xFD,0xFD,
                  0xFF,0xFD,0xFD,0xFD,0xFC,0xFC,0xFE,0xFF,0xFE,0xFC,0xFD,0xFC,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFD,0xFC,0xFC,0xFD,0xFF,0xFF,0xFC,0xFF,
                  0xFC,0xFF,0xFC,0xFF,0xFC,0xFC,0xFD,0xFC,0xFC,0xFD,0xF6,0xF4,0xF5,0xF0,0xF8,0xFF,0xFE,0xFC,0xFD,0xFD,0xFD,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0x37,0x07,0xA7,0x07,0x3F,0xF7,0x07,0x07,0xD7,0x07,0x2F,0xFF,0x0F,0x07,0xF7,0x67,0x67,0xF7,0x07,0x07,0xF7,0x07,0x0F,0xF7,
                  0x07,0x07,0xD7,0x57,0x77,0xF7,0x07,0x07,0xD7,0xD7,0xF7,0xFF,0x0F,0x07,0xB7,0x27,0x2F,0xF7,0x07,0x07,0xDF,0x07,0x07,0xF7,0xF7,0x07,0x07,
                  0xF7,0xFF,0x3F,0x3F,0xF7,0x07,0x07,0xF7,0xF7,0x07,0x07,0x9F,0x27,0x77,0xF7,0x07,0x07,0xF7,0x7F,0x7F,0xF7,0x07,0x8F,0x3F,0x8F,0x07,0xF7,
                  0x07,0x07,0xCF,0x37,0x07,0xF7,0x0F,0x07,0xF7,0x07,0x0F,0xF7,0x07,0x07,0xB7,0x87,0xCF,0xFF,0x0F,0x07,0xF7,0x07,0x0F,0xF7,0x07,0x07,0xB7,
                  0x07,0x4F,0xFF,0x4F,0xC7,0x97,0x17,0x27,0xE7,0xF7,0x07,0x07,0xF7,0xE7,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0xFF,0xFE,
                  0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFF,0xFF,0xFF,0xFE,0xFE,0xFE,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,
                  0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFF,0xFF,0xFE,0xFE,0xFE,0xFF,
                  0xFF,0xFE,0xFE,0xFE,0xFE,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFF,0xFE,0xFF,0xFE,0xFE,0xFE,0xFE,0xFF,0xFF,0xFE,0xFF,0xFF,
                  0xFE,0xFE,0xFE,0xFF,0xFE,0xFE,0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0xFC,0xFD,0xFE,0xFE,0xFE,0xFE,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,
                  0xFF,0xFF,0xFE,0xFE,0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0x83,0x03,0x7F,0x03,0x83,0xFB,0xF3,0x83,0x1F,0x83,0xF3,0xFB,0xC3,0x1F,0x83,0x1F,0xC3,0xFB,0x7B,0x33,0x87,0x87,0x33,0xFB,0xF3,0x63,
                  0x0F,0x0F,0x63,0xF3,0x33,0x13,0x4B,0x23,0x33,0xFF,0x7B,0x7B,0x01,0x01,0x7F,0x7F,0x3B,0x19,0x4D,0x21,0x33,0xFF,0xBB,0x29,0x6D,0x01,0x93,
                  0xFF,0xCF,0xC7,0xDB,0x01,0x01,0xDF,0x21,0x61,0x75,0x05,0x8D,0xFF,0x83,0x01,0x6D,0x09,0x9B,0xFF,0xF9,0x39,0x0D,0xC1,0xF1,0xFF,0x93,0x01,
                  0x6D,0x01,0x93,0xFF,0xB3,0x21,0x6D,0x01,0x83,0xFF,0x83,0x01,0x7D,0x01,0x83,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
                  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF]

class ST7567_LCD:
    def __init__(self, RST=24, A0=23, max_speed_hz=1953000, spi_port=0, spi_device=0):
        self.RST = RST
        self.A0 = A0
        self.max_speed_hz = max_speed_hz
        self.spi_port = spi_port
        self.spi_device = spi_device

    def __del__(self):
        self.close()

    def initialize(self):
        # Setup GPIO pins
        GPIO.setmode(GPIO.BCM)
        GPIO.setup(self.RST, GPIO.OUT)
        GPIO.setup(self.A0, GPIO.OUT)

        # Open SPI device
        self.spi = spidev.SpiDev()
        self.spi.open(self.spi_device, self.spi_port)
        self.spi.max_speed_hz = self.max_speed_hz

        # First reset the display
        GPIO.output(self.A0, 0)

        GPIO.output(self.RST, 1)
        sleep(0.3)
        GPIO.output(self.RST, 0)
        sleep(0.3)
        GPIO.output(self.RST, 1)

        # Send init sequence
        self.spi.xfer2([ST7567_BIAS_SELECT_1OVER9,
                        ST7567_SEG_DIRECTION_REVERSE,
                        ST7567_INVERSE_DISPLAY_OFF,
                        ST7567_COM_DIRECTION_REVERSE,
                        ST7567_SET_BOOSTER, 0,
                        ST7567_POWER_CONTROL | 0b111, # VB on, VR on, VF on
                        ST7567_REGULATION_RATIO | 0b110, # RR2 on, RR1 on, RR0 off
                        ST7567_SET_CONTRAST, 8,
                        ST7567_SET_START_LINE,
                        ST7567_DISPLAY_ON])
    
    def close(self):
        self.spi.xfer2([ST7567_DISPLAY_OFF,
                        ST7567_ALL_PIXEL_ON])
        sleep(0.25)
        self.spi.xfer2([ST7567_REGULATION_RATIO,
                        ST7567_POWER_CONTROL])
        self.spi.close()

    def clear(self, set_zeros=True):
        if set_zeros:
            self.show_image_raw([0x00] * 1024)
        else:
            self.show_image_raw([0xFF] * 1024)
    
    def invert(self, on=True):
        if on:
            self.spi.xfer([ST7567_INVERSE_DISPLAY_ON])
        else:
            self.spi.xfer([ST7567_INVERSE_DISPLAY_OFF])

    def show_image_raw(self, image):
        self.spi.xfer([ST7567_SET_START_LINE])
        for page in range(8):
            # Write page adress
            self.spi.xfer([ST7567_SET_PAGE_ADDRESS | page])
            # Set column adress
            self._set_column_adress(0)

            # Data mode on
            GPIO.output(self.A0, 1)
            self.spi.xfer2(image[page*128:(page+1)*128])
            GPIO.output(self.A0, 0)
    
    def show_image_binary(self, image):
        assert isinstance(image, np.ndarray), 'Image must be of type numpy ndarray'
        assert image.dtype == np.bool, 'Data needs to be binary'
        assert image.shape == (64, 128), 'Wrong image dimension. Must fit display dimensions (64 x 128)'
        

        # Convert binary image to raw and show
        # Note: np.packbits does not offer the bitorder parameter --> use flip
        self.show_image_raw(np.packbits(np.flip(image.T.reshape(128,8,8), axis=2), axis=2).T.flatten().tolist())
    
    def set_contrast(self, contrast):
        assert 0 <= contrast < 64, 'Contrast level should be in the range 0-63'
        self.spi.xfer2([ST7567_SET_CONTRAST, 
                        contrast])

    def _set_column_adress(self, addr):
        addr += 4
        self.spi.xfer2([(ST7567_SET_COLUMN_ADDRESS_MSB | addr >> 4), 
                        (ST7567_SET_COLUMN_ADDRESS_LSB & addr)])


if __name__ == '__main__':
    from time import sleep
    print('Running ST7567 unit test')

    print('Initializing display with default pinout (RST=24, A0=23)')
    LCD = ST7567_LCD()
    LCD.initialize()
    #sleep(2)

    print('Clearing display - zeros')
    LCD.clear()
    sleep(2)
    print('Clearing display - ones')
    LCD.clear(set_zeros=False)
    sleep(2)

    print('Showing binary image - horizontal line')
    LCD.show_image_binary(np.array([0]*128*31 + [1]*128*2 + [0]*128*31).reshape(64, 128).astype(np.bool))
    sleep(2)

    print('Showing binary image - diagonal line')
    diag_image = np.diag([1]*128)[0:64, :]
    LCD.show_image_binary(diag_image.astype(np.bool))
    sleep(2)

    print('Display test image')
    LCD.show_image_raw(image=test_image)
    sleep(2)

    print('Inverting contrast ON')
    LCD.invert()
    sleep(2)
    print('Inverting contrast OFF')
    LCD.invert(False)
    sleep(2)

    print('Set contrast level')
    for i in range(0,20):
        print(i)
        LCD.set_contrast(i)
        sleep(1)

    print('Done')